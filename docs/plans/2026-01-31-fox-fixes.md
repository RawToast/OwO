# Fox Fixes Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Fix 9 verified issues identified by the caffeinated fox review, avoiding files touched by commit 7fe528e.

**Architecture:** Direct fixes to documentation, JSON schema, and TypeScript source files. No new files needed.

**Tech Stack:** TypeScript, Zod, Markdown

---

## Task 1: Fix Markdown Code Fences (docs)

**Files:**

- Modify: `docs/plans/2026-01-30-comment-resolution.md:20,252,269`

**Step 1: Add language identifier to line 20**

Change line 20 from:

```

```

```

To:
```

```text

```

**Step 2: Add language identifier to line 252**

Change line 252 from:

```

```

````

To:
```text
````

**Step 3: Fix capitalization on line 269**

Change:

```
| `github/review.ts` | Add reply + resolve functions |
```

To:

```
| `GitHub/review.ts` | Add reply + resolve functions |
```

**Step 4: Verify changes**

Run: `cat docs/plans/2026-01-30-comment-resolution.md | head -35`
Expected: Line 20 shows ` ```text `

**Step 5: Commit**

```bash
git add docs/plans/2026-01-30-comment-resolution.md
git commit -m "docs: fix markdown code fences and capitalization in resolution plan"
```

---

## Task 2: Add `side` Field to Quality Example (docs)

**Files:**

- Modify: `packages/pr-review/examples/reviewers/quality.md:24-30`

**Step 1: Update JSON example to include side field**

Change:

```json
{
  "overview": "Concise summary of findings",
  "comments": [
    {
      "path": "src/file.ts",
      "line": 42,
      "body": "Describe the issue and recommended fix",
      "severity": "critical|warning|info"
    }
  ]
}
```

To:

```json
{
  "overview": "Concise summary of findings",
  "comments": [
    {
      "path": "src/file.ts",
      "line": 42,
      "body": "Describe the issue and recommended fix",
      "side": "RIGHT",
      "severity": "critical|warning|info"
    }
  ]
}
```

**Step 2: Commit**

```bash
git add packages/pr-review/examples/reviewers/quality.md
git commit -m "docs: add side field to quality reviewer example"
```

---

## Task 3: Fix JSON Schema Required Arrays

**Files:**

- Modify: `packages/pr-review/schema.json:44,76`

**Step 1: Remove `enabled` from reviewer required array (line 44)**

Change:

```json
"required": ["name", "enabled"],
```

To:

```json
"required": ["name"],
```

**Step 2: Remove all items from verifier required array (line 76)**

Change:

```json
"required": ["enabled", "level", "diagrams"],
```

To:

```json
"required": [],
```

**Step 3: Verify JSON is valid**

Run: `bun -e "console.log(JSON.parse(require('fs').readFileSync('packages/pr-review/schema.json', 'utf8')).verifier.required)"`
Expected: `[]`

**Step 4: Commit**

```bash
git add packages/pr-review/schema.json
git commit -m "fix(schema): remove properties with defaults from required arrays"
```

---

## Task 4: Add Early Guard for config.enabled in checker.ts

**Files:**

- Modify: `packages/pr-review/src/resolution/checker.ts:342-364`

**Step 1: Add early return when resolution is disabled**

After line 349 (`console.log(...Starting resolution check...)`), add:

```typescript
// Early exit if resolution checking is disabled
if (!config.enabled) {
  console.log("[pr-review] Resolution checking is disabled, skipping")
  return {
    checked: 0,
    fixed: 0,
    partiallyFixed: 0,
    notFixed: 0,
    deletedFiles: 0,
  }
}
```

**Step 2: Verify the change compiles**

Run: `bun run compile`
Expected: No errors

**Step 3: Commit**

```bash
git add packages/pr-review/src/resolution/checker.ts
git commit -m "fix(resolution): add early guard for disabled config"
```

---

## Task 5: Fix totalChecked Accuracy in checker.ts

**Files:**

- Modify: `packages/pr-review/src/resolution/checker.ts:405-433`

**Step 1: Log skipped comments and fix totalChecked**

Change the section at lines 405-433 from:

```typescript
// 5. Convert to OldComment format
const oldComments: OldComment[] = []
for (const comment of remainingComments) {
  const threadId = commentThreadMap.get(comment.id)
  if (threadId) {
    oldComments.push(toOldComment(comment, threadId))
  }
}

// 6. Call resolution agent
const resolutionInput: ResolutionInput = {
  prTitle: pr.title,
  prDescription: pr.body,
  oldComments,
  currentCode: codeSnippets,
  recentCommits: pr.commits.map((c) => ({ sha: c.oid, message: c.message })),
}

const { results } = await checkResolutions(ai, resolutionInput, config)

// 7. Process results with rate limiting
const { fixed, partiallyFixed, notFixed } = await processResults(
  github,
  results,
  commentThreadMap,
  semaphore,
)

const totalChecked = owoComments.length
```

To:

```typescript
// 5. Convert to OldComment format (log skipped comments)
const oldComments: OldComment[] = []
let skippedCount = 0
for (const comment of remainingComments) {
  const threadId = commentThreadMap.get(comment.id)
  if (threadId) {
    oldComments.push(toOldComment(comment, threadId))
  } else {
    console.warn(`[pr-review] Skipping comment ${comment.id}: no thread ID found`)
    skippedCount++
  }
}

if (skippedCount > 0) {
  console.log(`[pr-review] Skipped ${skippedCount} comments without thread IDs`)
}

// 6. Call resolution agent
const resolutionInput: ResolutionInput = {
  prTitle: pr.title,
  prDescription: pr.body,
  oldComments,
  currentCode: codeSnippets,
  recentCommits: pr.commits.map((c) => ({ sha: c.oid, message: c.message })),
}

const { results } = await checkResolutions(ai, resolutionInput, config)

// 7. Process results with rate limiting
const { fixed, partiallyFixed, notFixed } = await processResults(
  github,
  results,
  commentThreadMap,
  semaphore,
)

// Use actual processed count, not original count
const totalChecked = oldComments.length + deletedFiles
```

**Step 2: Verify the change compiles**

Run: `bun run compile`
Expected: No errors

**Step 3: Commit**

```bash
git add packages/pr-review/src/resolution/checker.ts
git commit -m "fix(resolution): log skipped comments and fix totalChecked accuracy"
```

---

## Task 6: Fix Null Safety in threads.ts

**Files:**

- Modify: `packages/pr-review/src/resolution/threads.ts:3-7,91-98`

**Step 1: Update ReviewThread type to allow null**

Change line 6:

```typescript
commentDatabaseId: number
```

To:

```typescript
commentDatabaseId: number | null
```

**Step 2: Remove unsafe cast and handle null properly**

Change lines 91-98 from:

```typescript
for (const node of reviewThreads.nodes ?? []) {
  const commentDatabaseId = node.comments?.nodes?.[0]?.databaseId
  threads.push({
    id: node.id,
    isResolved: node.isResolved,
    commentDatabaseId: commentDatabaseId as number,
  })
}
```

To:

```typescript
for (const node of reviewThreads.nodes ?? []) {
  const commentDatabaseId = node.comments?.nodes?.[0]?.databaseId ?? null
  threads.push({
    id: node.id,
    isResolved: node.isResolved,
    commentDatabaseId,
  })
}
```

**Step 3: Update mapCommentsToThreads in checker.ts to handle null**

The existing code at line 128 already handles this:

```typescript
if (thread.commentDatabaseId) {
```

This will now correctly skip null values. No change needed.

**Step 4: Verify the change compiles**

Run: `bun run compile`
Expected: No errors

**Step 5: Commit**

```bash
git add packages/pr-review/src/resolution/threads.ts
git commit -m "fix(resolution): handle null commentDatabaseId safely"
```

---

## Task 7: Fix Deduplication Key in synthesizer.ts

**Files:**

- Modify: `packages/pr-review/src/verifier/synthesizer.ts:117`

**Step 1: Include side in deduplication key**

Change line 117 from:

```typescript
const key = `${comment.path}:${comment.line}`
```

To:

```typescript
const key = `${comment.path}:${comment.line}:${comment.side ?? "RIGHT"}`
```

**Step 2: Verify the change compiles**

Run: `bun run compile`
Expected: No errors

**Step 3: Commit**

```bash
git add packages/pr-review/src/verifier/synthesizer.ts
git commit -m "fix(verifier): include side in deduplication key to preserve LEFT/RIGHT comments"
```

---

## Task 8: Add Timeout to Verifier Prompt Call

**Files:**

- Modify: `packages/pr-review/src/verifier/synthesizer.ts:42-54`

**Step 1: Add timeout wrapper around prompt call**

Change lines 42-54 from:

```typescript
  try {
    console.log("[pr-review] Running verifier to synthesize overview...")

    const overviewPrompt = buildOverviewPrompt(outputs, verifierConfig, repoRoot, prData)
    const modelConfig = verifierConfig.model
      ? {
          providerID: verifierConfig.model.split("/")[0],
          modelID: verifierConfig.model.split("/").slice(1).join("/"),
        }
      : undefined

    const { response } = await prompt(ai, overviewPrompt, { model: modelConfig })
```

To:

```typescript
  try {
    console.log("[pr-review] Running verifier to synthesize overview...")

    const overviewPrompt = buildOverviewPrompt(outputs, verifierConfig, repoRoot, prData)
    const modelConfig = verifierConfig.model
      ? {
          providerID: verifierConfig.model.split("/")[0],
          modelID: verifierConfig.model.split("/").slice(1).join("/"),
        }
      : undefined

    // Add timeout to prevent hanging on slow AI responses
    const VERIFIER_TIMEOUT_MS = 60_000 // 60 seconds
    const timeoutPromise = new Promise<never>((_, reject) => {
      setTimeout(() => reject(new Error("Verifier prompt timed out")), VERIFIER_TIMEOUT_MS)
    })

    const { response } = await Promise.race([
      prompt(ai, overviewPrompt, { model: modelConfig }),
      timeoutPromise,
    ])
```

**Step 2: Verify the change compiles**

Run: `bun run compile`
Expected: No errors

**Step 3: Commit**

```bash
git add packages/pr-review/src/verifier/synthesizer.ts
git commit -m "fix(verifier): add timeout to prevent hanging on slow AI responses"
```

---

## Task 9: Final Verification

**Step 1: Run full typecheck**

Run: `bun run compile`
Expected: No errors

**Step 2: Run linter**

Run: `bun run lint`
Expected: No errors (or only pre-existing ones)

**Step 3: Run tests**

Run: `bun test packages/pr-review/`
Expected: All tests pass

**Step 4: Format code**

Run: `bun run format`

**Step 5: Final commit if formatting changed anything**

```bash
git add -A
git status
# If there are changes:
git commit -m "style: format code"
```

---

## Summary

| Task | File                                             | Fix                                          |
| ---- | ------------------------------------------------ | -------------------------------------------- |
| 1    | docs/plans/2026-01-30-comment-resolution.md      | Add language identifiers, fix capitalization |
| 2    | packages/pr-review/examples/reviewers/quality.md | Add `side` field to example                  |
| 3    | packages/pr-review/schema.json                   | Remove defaults from required arrays         |
| 4    | packages/pr-review/src/resolution/checker.ts     | Early guard for disabled config              |
| 5    | packages/pr-review/src/resolution/checker.ts     | Fix totalChecked accuracy                    |
| 6    | packages/pr-review/src/resolution/threads.ts     | Null safety for commentDatabaseId            |
| 7    | packages/pr-review/src/verifier/synthesizer.ts   | Include side in dedup key                    |
| 8    | packages/pr-review/src/verifier/synthesizer.ts   | Add timeout to prompt call                   |
| 9    | -                                                | Final verification                           |

**Skipped (conflict with 7fe528e):**

- `src/config/types.ts` - model validation
- `src/reviewers/runner.ts` - timer cleanup
- `test/reviewers.test.ts` - missing assertions
